<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">

<meta name="viewport" content="width=device-width, 
    user-scalable=no, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<head>
	<title>Jump ahead</title>
</head>
<style type="text/css">
	html { width: 100%; height: 100%; }
	body { width: 100%; height: 100%; margin: 0; padding: 0; background: #000;}
	#viewport {
		height: 400px;
		width: 240px;
		top: 0;
		bottom: 0;
		left: 0;
		right: 0;
		position: absolute;
		margin: auto;
		background: #EDEDED;
		overflow: hidden;
	}
	.block {
		position: absolute;
		width: 100px;
		height: 100px;
		top: 50%;
		left: 30%;
		background: #FEFEFE;
		border-radius: 3px;
  		border-bottom: 2px solid #cbcbcb;
  		border-right: 2px solid #cbcbcb;
		transform: rotateX(60deg) rotateY(0deg) rotateZ(45deg) translate(0, 0);
	}
</style>
<body>
<div id="viewport">
	<div class="block"></div>
</div>
<script type="text/javascript">
window.requestAnimFrame = (function(){
  return  window.requestAnimationFrame       || 
          window.webkitRequestAnimationFrame || 
          window.mozRequestAnimationFrame    || 
          window.oRequestAnimationFrame      || 
          window.msRequestAnimationFrame     || 
          function( callback ){
            window.setTimeout(callback, 1000 / 60);
          };
})();

var platforms = [];

var JUMP = {
	WIDTH: 480,
    HEIGHT: 800,
    DEVICE_WIDTH: null,
    DEVICE_HEIGHT: null,

    scale: 1,
    offset: { top: 0, left: 0 },

    RATIO: null,
    currentWidth: null,
    currentHeight: null,
    VIEWPORT: null,

	setup: function() {
		JUMP.RATIO = JUMP.WIDTH / JUMP.HEIGHT;
        JUMP.currentWidth = JUMP.WIDTH;
        JUMP.currentHeight = JUMP.HEIGHT;

        JUMP.VIEWPORT = document.querySelector("#viewport");

        JUMP.ua = navigator.userAgent.toLowerCase();
        JUMP.android = JUMP.ua.indexOf('android') > -1 ? true : false;
        JUMP.ios = ( JUMP.ua.indexOf('iphone') > -1 || JUMP.ua.indexOf('ipad') > -1  ) ? true : false;
        
        JUMP.STAGES.set(JUMP.STAGES.LOAD);

        JUMP.init();
        JUMP.resize();
        JUMP.loop();
	},

	init: function() {

	},

	resize: function() {
		JUMP.DEVICE_WIDTH = window.innerWidth;
        JUMP.DEVICE_HEIGHT = window.innerHeight;

        var ratio = JUMP.DEVICE_WIDTH / JUMP.DEVICE_HEIGHT,
            scale = 1;

        // WIDTH higher then HEIGHT
        if (ratio > JUMP.RATIO) {
            scale = JUMP.DEVICE_HEIGHT / JUMP.HEIGHT;
            JUMP.scale = JUMP.currentWidth * scale / JUMP.WIDTH;
        } // HEIGHT higher then WIDTH
        else if (ratio < JUMP.RATIO) {
            scale = JUMP.DEVICE_WIDTH / JUMP.WIDTH;            
            JUMP.scale = JUMP.currentHeight * scale / JUMP.HEIGHT;
        }

        JUMP.currentHeight = JUMP.HEIGHT * scale;
        JUMP.currentWidth = JUMP.WIDTH * scale;

        JUMP.offset.top = JUMP.VIEWPORT.offsetTop;
        JUMP.offset.left = JUMP.VIEWPORT.offsetLeft;

        if (JUMP.android || JUMP.ios) {

        }

        JUMP.VIEWPORT.style.width = JUMP.currentWidth + 'px';
        JUMP.VIEWPORT.style.height = JUMP.currentHeight + 'px';
	},

	update: function() {
        JUMP.STAGES.update();
    },

    render: function() {

        JUMP.STAGES.render();
    },

    loop: function() {
        JUMP.update();
        JUMP.render();

        window.requestAnimFrame(JUMP.loop);
    }
};

JUMP.load = {
	images: [],
	audios: [],
	totalCount: 0,
	count: 0,
	barWidth: 0,
	image: function(name, src) {
		this.totalCount++;
		var _self = this;
		this.images[name] = new Image();
		this.images[name].onload = function() {
			_self.count++;
		}
		this.images[name].src = src;
	},

	audio: function(name, src) {
		this.totalCount++;
		var _self = this;
		this.audios[name] = new Audio(src);
		this.audios[name].onloadeddata = function() {
			_self.count++;
		}
	},

	render: function() {
		var percent = this.count / this.totalCount;

		JUMP.Draw.roundRect(40, 400, 400, 50, 10, false, "#000");
		if (percent) {
			var dx = 390 * percent - this.barWidth,
				vx = dx * 0.04;
			this.barWidth += vx;
			JUMP.Draw.roundRect(45, 405, this.barWidth, 40, 6, true, "#000");
			JUMP.Draw.centeredText(~~(percent * 100) + "%", JUMP.WIDTH / 2 + 2, 433, 25, "#83d0bc");
		}
	}
};


var Platform = function(x, y, width, height, type, image) {
	this.type = type || null;
	this.elem = document.createElement("div");
	this.x = x || 0;
	this.y = y || 0;
	this.constX = this.x;
	this.constY = this.y;
	this.width = width;
	this.height = height;

	this.update = function() {

	};

	this.render = function() {

	};
};

JUMP.STAGES = {
	LOAD: "load",
    MENU: "menu",
    GAMEPLAY: "gameplay",
    currentStage: null,

    set: function(stage) {
        this.currentStage = stage;
        window.location.hash = stage;
    },

    checkStage: function() {
        var stageForCheck = window.location.href.split('#')[1];
        if (this.currentStage !== stageForCheck)
            this.currentStage = stageForCheck;
    },

    update: function() {
        this.checkStage();

        switch (this.currentStage) {
	    	case JUMP.STAGES.LOAD:
	            if (Math.round(JUMP.load.barWidth) == 390 || JUMP.load.totalCount == 0) {
	        		this.set(JUMP.STAGES.GAMEPLAY);
	            }
	        	break;
            case this.MENU:
                
                break;
            case this.GAMEPLAY:
            	
                break;
        }
    },

    render: function() {
        switch (this.currentStage) {
	    	case JUMP.STAGES.LOAD:
        		JUMP.load.render();
	        	break;
            case this.MENU:
            	JUMP.Draw.text("Everything is loaded!!", 20, 100, 30, "#000");
                break;
            case this.GAMEPLAY:

                break;
        }
    }
};

JUMP.collide = function(platform, obj2) {
	return platform.x < obj2.x + obj2.width &&
		   platform.x + platform.width > obj2.x &&
		   platform.y + platform.height > obj2.y &&
		   platform.y < obj2.y + obj2.height;
};

window.addEventListener("touchstart", function(e) {
    e.preventDefault();
    if (e.touches.length == 1) {
	    var touch = e.touches[0];
	    switch (JUMP.STAGES.currentStage) {
	    	case JUMP.STAGES.LOAD:

	        	break;
	        case JUMP.STAGES.MENU:

	            break;
	        case JUMP.STAGES.GAMEPLAY:

	            break;
	    }
	}
}, false);

function generatePlatforms() {

}

function toIso(x, y) {
  var newX = (x - y),
      newY = (x + y) / 2;
  return { x: newX, y: newY };
}

window.addEventListener("touchend", function(e) {
	e.preventDefault();
	switch (JUMP.STAGES.currentStage) {
	    case JUMP.STAGES.LOAD:

	        break;
	    case JUMP.STAGES.MENU:

	        break;
	    case JUMP.STAGES.GAMEPLAY:

	        break;
	}
}, false);

window.addEventListener('load', JUMP.setup, false);
window.addEventListener('resize', JUMP.resize, false);
</script>
</body>
</html>